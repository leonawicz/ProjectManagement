<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    <link rel='stylesheet' href='http://timelyportfolio.github.io/rCharts_d3_sankey/libraries/widgets/d3_sankey/css/sankey.css'>
    
    <script src='http://timelyportfolio.github.io/rCharts_d3_sankey/libraries/widgets/d3_sankey/js/d3.v3.js' type='text/javascript'></script>
    <script src='http://timelyportfolio.github.io/rCharts_d3_sankey/libraries/widgets/d3_sankey/js/sankey.js' type='text/javascript'></script>
    
    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 800px;
      height: 600px;
    }  
    </style>
    
  </head>
  <body >
    
    <div id = 'chart1b806ad57c2f' class = 'rChart d3_sankey'></div>    
    ﻿<!--Attribution:
Mike Bostock https://github.com/d3/d3-plugins/tree/master/sankey
Mike Bostock http://bost.ocks.org/mike/sankey/
-->

<script>
(function(){
var params = {
 "dom": "chart1b806ad57c2f",
"width":    800,
"height":    600,
"data": {
 "source": [ "Collaborators", "Collaborators", "Collaborators", "Collaborators", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Matt", "Paul", "Matt", "Paul", "Matt", "Paul", "Matt", "Paul", "Matt", "Paul", "Matt", "Paul", "Matt", "Paul", "Matt", "Matt", "Matt", "Matt", "Matt", "Paul", "Alec", "Angie", "Angie", "Bob", "Angie", "Bob", "Alfresco Outputs", "Alfresco Outputs", "Alfresco Outputs", "SNAP Data QA/QC", "SNAP Data QA/QC", "SNAP Data QA/QC", "SNAP Data QA/QC", "Spatial Lightning Analysis", "Spatial Lightning Analysis", "Spatial Lightning Analysis", "Sea Ice Edge Maps and Spinoff Projects", "Sea Ice Edge Maps and Spinoff Projects", "Training/Supervision", "Training/Supervision", "Randscape Development", "Randscape Development", "Effective Spatial Scale Analysis", "Effective Spatial Scale Analysis", "NWT/Comm. Charts DS", "Alfresco Noatak", "Alfresco Statewide", "Data Extraction and Uncertainty Analysis", "Data Extraction and Uncertainty Analysis", "Data Extraction and Uncertainty Analysis", "Data Extraction and Uncertainty Analysis" ],
"target": [ "Paul", "Alec", "Angie", "Bob", "CMIP3/CMIP5 GCM Comparisons", "Effective Spatial Scale Analysis", "Randscape Development", "Alfresco Outputs", "SNAP Data QA/QC", "Training/Supervision", "R Shiny Apps General Maintenance", "New App Development", "SNAP Tech Blog", "Continuing Education", "FRP/FRI Scale-Conditional Alfresco Maps", "Moose Project", "Alfresco Noatak", "Alfresco Statewide", "Spatial Lightning Analysis", "Data Extraction and Uncertainty Analysis", "Growing Season", "Mussel Project", "Land Carbon", "Alfresco Noatak", "Alfresco Statewide", "Spatial Lightning Analysis", "Data Extraction and Uncertainty Analysis", "Growing Season", "Mussel Project", "Land Carbon", "Alfresco CRU/GCM Experimental Design", "Bird Project", "NWT/Comm. Charts DS", "Sea Ice Edge Maps and Spinoff Projects", "Shiny App Server Migration", "Alfresco CRU/GCM Experimental Design", "Alfresco CRU/GCM Experimental Design", "Bird Project", "NWT/Comm. Charts DS", "NWT/Comm. Charts DS", "Sea Ice Edge Maps and Spinoff Projects", "Shiny App Server Migration", "CMIP3/CMIP5 GCM Comparisons", "Land Carbon", "Bird Project", "Alfresco Outputs", "CMIP3/CMIP5 GCM Comparisons", "Alfresco CRU/GCM Experimental Design", "NWT/Comm. Charts DS", "Alfresco Noatak", "Alfresco Statewide", "Randscape Development", "Randscape Development", "Alfresco Outputs", "Bird Project", "NWT/Comm. Charts DS", "Alfresco Outputs", "Effective Spatial Scale Analysis", "Alfresco Outputs", "FRP/FRI Scale-Conditional Alfresco Maps", "CMIP3/CMIP5 GCM Comparisons", "FRP/FRI Scale-Conditional Alfresco Maps", "FRP/FRI Scale-Conditional Alfresco Maps", "CMIP3/CMIP5 GCM Comparisons", "Effective Spatial Scale Analysis", "Randscape Development", "Alfresco Outputs" ],
"value": [      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1,      1 ] 
},
"nodeWidth":     15,
"nodePadding":     10,
"layout":     32,
"margin": {
 "right":     20,
"left":     20,
"bottom":     50,
"top":     50 
},
"title": "Matt's Projects",
"id": "chart1b806ad57c2f" 
};

params.units ? units = " " + params.units : units = "";

//hard code these now but eventually make available
var formatNumber = d3.format("0,.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + units; },
    color = d3.scale.category20();

if(params.labelFormat){
  formatNumber = d3.format(".2%");
}

var svg = d3.select('#' + params.id).append("svg")
    .attr("width", params.width)
    .attr("height", params.height);
    
var sankey = d3.sankey()
    .nodeWidth(params.nodeWidth)
    .nodePadding(params.nodePadding)
    .layout(params.layout)
    .size([params.width,params.height]);
    
var path = sankey.link();
    
var data = params.data,
    links = [],
    nodes = [];
    
//get all source and target into nodes
//will reduce to unique in the next step
//also get links in object form
data.source.forEach(function (d, i) {
    nodes.push({ "name": data.source[i] });
    nodes.push({ "name": data.target[i] });
    links.push({ "source": data.source[i], "target": data.target[i], "value": +data.value[i] });
}); 

//now get nodes based on links data
//thanks Mike Bostock https://groups.google.com/d/msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ
//this handy little function returns only the distinct / unique nodes
nodes = d3.keys(d3.nest()
                .key(function (d) { return d.name; })
                .map(nodes));

//it appears d3 with force layout wants a numeric source and target
//so loop through each link replacing the text with its index from node
links.forEach(function (d, i) {
    links[i].source = nodes.indexOf(links[i].source);
    links[i].target = nodes.indexOf(links[i].target);
});

//now loop through each nodes to make nodes an array of objects rather than an array of strings
nodes.forEach(function (d, i) {
    nodes[i] = { "name": d };
});

sankey
  .nodes(nodes)
  .links(links)
  .layout(params.layout);
  
var link = svg.append("g").selectAll(".link")
  .data(links)
.enter().append("path")
  .attr("class", "link")
  .attr("d", path)
  .style("stroke-width", function (d) { return Math.max(1, d.dy); })
  .sort(function (a, b) { return b.dy - a.dy; });

link.append("title")
  .text(function (d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

var node = svg.append("g").selectAll(".node")
  .data(nodes)
.enter().append("g")
  .attr("class", "node")
  .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
.call(d3.behavior.drag()
  .origin(function (d) { return d; })
  .on("dragstart", function () { this.parentNode.appendChild(this); })
  .on("drag", dragmove));

node.append("rect")
  .attr("height", function (d) { return d.dy; })
  .attr("width", sankey.nodeWidth())
  .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
  .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
.append("title")
  .text(function (d) { return d.name + "\n" + format(d.value); });

node.append("text")
  .attr("x", -6)
  .attr("y", function (d) { return d.dy / 2; })
  .attr("dy", ".35em")
  .attr("text-anchor", "end")
  .attr("transform", null)
  .text(function (d) { return d.name; })
.filter(function (d) { return d.x < params.width / 2; })
  .attr("x", 6 + sankey.nodeWidth())
  .attr("text-anchor", "start");

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + (
                   d.x = Math.max(0, Math.min(params.width - d.dx, d3.event.x))
                ) + "," + (
                   d.y = Math.max(0, Math.min(params.height - d.dy, d3.event.y))
                ) + ")");
        sankey.relayout();
        link.attr("d", path);
  }
})();
</script>
    
    
    <script>
      var cscale = d3.scale.category20b();
    
      // to be specific in case you have more than one chart
      d3.selectAll('#chart1b806ad57c2f svg path.link')
        .style('stroke', function(d){
          //here we will use the source color
          //if you want target then sub target for source
          //or if you want something other than gray
          //supply a constant
          //or use a categorical scale or gradient
          //return d.source.color;
          return cscale(d.source.name);
        })
       //note no changes were made to opacity
       //to do uncomment below but will affect mouseover
       //so will need to define mouseover and mouseout
       //happy to show how to do this also
       // .style('stroke-opacity', .7)
      d3.selectAll('#chart1b806ad57c2f svg .node rect')
        .style('fill', function(d){
          return cscale(d.name)
        })
        .style('stroke', 'none')
    </script>
        
  </body>
</html>
